<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–≥–æ –±–∞–ª–∞</title>
</head>
<body>

<h1>üìä –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–Ω–æ–≥–æ –±–∞–ª–∞</h1>

<form id="scoreForm">
    <label>–û–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å:</label>
    <select name="specialtyId" id="specialtySelect" required>
        <option value="" disabled selected>-- –û–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å --</option>
        <option th:each="s : ${specialtyCoefficients}"
                th:value="${s.id}"
                th:text="${s.name}"></option>
    </select><br><br>

    <div id="subjectsArea"></div>

    <button type="submit">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
</form>

<div id="result" style="margin-top: 20px; font-weight: bold;"></div>

<script>
    const specialtySelect = document.getElementById('specialtySelect');
    const subjectsArea = document.getElementById('subjectsArea');

    specialtySelect.addEventListener('change', function () {
        const specialtyId = this.value;
        if (!specialtyId) return;

        fetch('/get-coefs/' + specialtyId)
            .then(res => res.json())
            .then(coefs => {
                subjectsArea.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø–æ–ª—è

                for (const [subject, coef] of Object.entries(coefs)) {
                    subjectsArea.innerHTML += `
                        <div style="margin-bottom: 8px;">
                            <label>${getSubjectName(subject)} (–∫–æ–µ—Ñ. ${coef}):</label>
                            <input type="number" step="0.1" name="${subject}" placeholder="–í–∞—à –±–∞–ª, —è–∫—â–æ —Å–∫–ª–∞–¥–∞–ª–∏">
                        </div>
                    `;
                }
            });
    });

    // –ù–∞–∑–≤–∏ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    function getSubjectName(code) {
        const names = {
            "ukr_mova": "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞",
            "math": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
            "history": "–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏",
            "language": "–Ü–Ω–æ–∑–µ–º–Ω–∞ –º–æ–≤–∞",
            "biology": "–ë—ñ–æ–ª–æ–≥—ñ—è",
            "physics": "–§—ñ–∑–∏–∫–∞",
            "chemistry": "–•—ñ–º—ñ—è",
            "literature": "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä–∞",
            "geography": "–ì–µ–æ–≥—Ä–∞—Ñ—ñ—è"
        };
        return names[code] || code;
    }

    document.getElementById('scoreForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const specialtyId = specialtySelect.value;
        const inputs = document.querySelectorAll('#subjectsArea input');
        const subjectScores = {};

        inputs.forEach(input => {
            const value = parseFloat(input.value);
            if (!isNaN(value)) {
                subjectScores[input.name] = value;
            }
        });

        if (Object.keys(subjectScores).length !== 4) {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ä—ñ–≤–Ω–æ 4 –ø—Ä–µ–¥–º–µ—Ç–∏, —è–∫—ñ –≤–∏ —Å–∫–ª–∞–¥–∞–ª–∏.");
            return;
        }

        const payload = {
            specialtyId: parseInt(specialtyId),
            subjectScores: subjectScores
        };

        fetch('/calc-score', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
            .then(res => res.text())
            .then(score => {
                const parsed = parseFloat(score);
                if (!isNaN(parsed)) {
                    document.getElementById('result').innerText = '‚úÖ –í–∞—à –∫–æ–Ω–∫—É—Ä—Å–Ω–∏–π –±–∞–ª: ' + parsed.toFixed(2);
                } else {
                    document.getElementById('result').innerText = '‚ùå –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ —á–∏—Å–ª–æ';
                }
            })
            .catch(() => {
                document.getElementById('result').innerText = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É';
            });
    });
</script>

</body>
</html>
